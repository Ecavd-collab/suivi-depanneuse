<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi D√©panneuse - Eyrieux Centre Auto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #000;
            color: #FFD100;
            padding: 30px 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            background: #fff;
            border: 2px solid #FFD100;
            padding: 15px 25px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .tab-button:hover {
            background: #FFD100;
        }

        .tab-button.active {
            background: #FFD100;
            color: #000;
        }

        .tab-content {
            display: none;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #000;
        }

        label.required:after {
            content: " *";
            color: #ff4444;
        }

        input[type="text"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #FFD100;
        }

        .fuel-slider {
            width: 100%;
            height: 40px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #ff4444 0%, #ffaa00 50%, #4CAF50 100%);
            border-radius: 20px;
            outline: none;
        }

        .fuel-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: #000;
            border: 3px solid #FFD100;
            border-radius: 50%;
            cursor: pointer;
        }

        .fuel-display {
            text-align: center;
            font-weight: 600;
            margin-top: 10px;
            color: #000;
            font-size: 1.1em;
        }

        .submit-btn {
            background: #FFD100;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .submit-btn:hover {
            opacity: 0.9;
        }

        .success-message {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            color: #ff4444;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .section-title {
            background: #FFD100;
            color: #000;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.2em;
        }

        .intervention-card {
            background: white;
            border: 2px solid #FFD100;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .intervention-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #FFD100;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-en-cours {
            background: #ff9800;
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
        }

        .btn-complete {
            background: #4CAF50;
            color: white;
        }

        .btn-pdf {
            background: #9C27B0;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .photo-upload {
            margin: 15px 0;
        }

        .photo-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #000;
            color: #FFD100;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöõ Suivi D√©panneuse</h1>
            <p>Eyrieux Centre Auto - Version 4 Stable</p>
        </header>

        <div class="nav-tabs">
            <button class="tab-button active" onclick="showTab('saisie')">üìù Nouvelle sortie</button>
            <button class="tab-button" onclick="showTab('encours')">üîÑ Sorties en cours</button>
            <button class="tab-button" onclick="showTab('suivi')">üìä Suivi</button>
        </div>

        <!-- ONGLET 1: NOUVELLE SORTIE -->
        <div id="tab-saisie" class="tab-content active">
            <div class="section-title">Fiche de sortie - √Ä remplir AVANT chaque d√©part</div>
            <div class="success-message" id="successMessage">‚úÖ Sortie enregistr√©e avec succ√®s !</div>
            
            <form id="depanneuseForm">
                <div class="form-group">
                    <label for="date" class="required">Date</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label for="conducteur" class="required">Conducteur</label>
                    <select id="conducteur" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="Vivien">Vivien</option>
                        <option value="Quentin">Quentin</option>
                        <option value="Romain">Romain</option>
                        <option value="Rom√©o">Rom√©o</option>
                        <option value="Nicolas">Nicolas</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="niveauCarburant" class="required">Niveau carburant d√©panneuse</label>
                    <input type="range" id="niveauCarburant" class="fuel-slider" min="0" max="100" value="50" oninput="updateFuel(this.value)">
                    <div class="fuel-display" id="fuelDisplay">50%</div>
                </div>

                <div class="form-group">
                    <label for="typeMission" class="required">Type de mission</label>
                    <select id="typeMission" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="Rapatriement v√©hicule d'occasion">Rapatriement VO</option>
                        <option value="D√©pannage client">D√©pannage client</option>
                        <option value="Livraison v√©hicule client">Livraison client</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="clientNom" class="required">Nom du client</label>
                    <input type="text" id="clientNom" required>
                </div>

                <div class="form-group">
                    <label for="clientTel" class="required">T√©l√©phone client (10 chiffres)</label>
                    <input type="tel" id="clientTel" maxlength="10" required>
                    <div class="error-message" id="telError">Le num√©ro doit contenir exactement 10 chiffres</div>
                </div>

                <div class="form-group">
                    <label for="lieuDepart" class="required">Lieu de d√©part</label>
                    <input type="text" id="lieuDepart" value="ECA VD, 6 Quartier les Rami√®res, 07800 Beauchastel" required>
                </div>

                <div class="form-group">
                    <label for="lieuArrivee" class="required">Adresse compl√®te d'arriv√©e</label>
                    <input type="text" id="lieuArrivee" required>
                    <div class="help-text">Cette adresse sera cliquable pour GPS</div>
                </div>

                <div class="form-group">
                    <label for="kmDepart" class="required">KM au compteur D√âPART (d√©panneuse)</label>
                    <input type="number" id="kmDepart" required>
                </div>

                <div class="form-group">
                    <label for="immatriculation" class="required">Immatriculation v√©hicule</label>
                    <input type="text" id="immatriculation" placeholder="Ex: EP-375-WE" required>
                </div>

                <div class="form-group">
                    <label for="marque" class="required">Marque v√©hicule</label>
                    <input type="text" id="marque" placeholder="Ex: Seat" required>
                </div>

                <div class="form-group">
                    <label for="modele" class="required">Mod√®le v√©hicule</label>
                    <input type="text" id="modele" placeholder="Ex: Leon" required>
                </div>

                <div class="form-group">
                    <label for="commentaire">Commentaire</label>
                    <textarea id="commentaire" rows="3"></textarea>
                </div>

                <button type="submit" class="submit-btn">‚úÖ Enregistrer la sortie</button>
            </form>
        </div>

        <!-- ONGLET 2: SORTIES EN COURS -->
        <div id="tab-encours" class="tab-content">
            <div class="section-title">Sorties en cours</div>
            <div id="listeEnCours"></div>
            <div id="emptyEnCours" class="empty-state" style="display:none;">
                <p>Aucune sortie en cours</p>
            </div>
        </div>

        <!-- ONGLET 3: SUIVI -->
        <div id="tab-suivi" class="tab-content">
            <div class="section-title">Suivi des sorties</div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Heure</th>
                        <th>Conducteur</th>
                        <th>Client</th>
                        <th>V√©hicule</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableSuivi"></tbody>
            </table>
            <div id="emptySuivi" class="empty-state" style="display:none;">
                <p>Aucune sortie enregistr√©e</p>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        console.log('üöÄ D√©marrage de l\'application');
        
        // STOCKAGE
        let sorties = [];
        
        // Charger les donn√©es au d√©marrage
        function chargerDonnees() {
            try {
                const data = localStorage.getItem('depanneuse_sorties');
                if (data) {
                    sorties = JSON.parse(data);
                    
                    // Recharger PDF depuis le storage s√©par√©
                    sorties.forEach(s => {
                        if (s.hasPDF) {
                            s.pdfGenere = localStorage.getItem(`pdf_${s.id}`);
                        }
                    });
                    
                    console.log('‚úÖ Donn√©es charg√©es:', sorties.length, 'sorties');
                } else {
                    console.log('‚ÑπÔ∏è Aucune donn√©e existante');
                }
            } catch (e) {
                console.error('‚ùå Erreur chargement:', e);
                sorties = [];
            }
        }

        // Sauvegarder les donn√©es
        function sauvegarderDonnees() {
            try {
                // Cr√©er une copie all√©g√©e
                const sortiesAll√©g√©es = sorties.map(s => {
                    const copie = {...s};
                    // Sauvegarder PDF s√©par√©ment (volumineux)
                    if (copie.pdfGenere) {
                        localStorage.setItem(`pdf_${copie.id}`, copie.pdfGenere);
                        copie.hasPDF = true;
                        delete copie.pdfGenere;
                    }
                    return copie;
                });
                
                localStorage.setItem('depanneuse_sorties', JSON.stringify(sortiesAll√©g√©es));
                console.log('‚úÖ Donn√©es sauvegard√©es:', sorties.length, 'sorties');
                return true;
            } catch (e) {
                console.error('‚ùå Erreur sauvegarde:', e);
                if (e.name === 'QuotaExceededError') {
                    alert('ERREUR: Espace de stockage insuffisant.\n\nVeuillez supprimer d\'anciennes interventions.');
                } else {
                    alert('ERREUR: Impossible de sauvegarder.');
                }
                return false;
            }
        }

        // INITIALISATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã Initialisation...');
            document.getElementById('date').valueAsDate = new Date();
            chargerDonnees();
            afficherEnCours();
            afficherSuivi();
            
            // Validation t√©l√©phone
            document.getElementById('clientTel').addEventListener('input', function(e) {
                const val = e.target.value.replace(/\D/g, '');
                e.target.value = val;
                const err = document.getElementById('telError');
                if (val.length !== 10 && val.length > 0) {
                    err.style.display = 'block';
                } else {
                    err.style.display = 'none';
                }
            });
        });

        // Mise √† jour affichage carburant
        function updateFuel(val) {
            document.getElementById('fuelDisplay').textContent = val + '%';
        }

        // NAVIGATION ONGLETS
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'encours') afficherEnCours();
            if (tabName === 'suivi') afficherSuivi();
        }

        // SOUMISSION FORMULAIRE
        document.getElementById('depanneuseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('üìù Soumission formulaire...');
            
            // Validation t√©l√©phone
            const tel = document.getElementById('clientTel').value;
            if (tel.length !== 10) {
                alert('Le num√©ro de t√©l√©phone doit contenir exactement 10 chiffres');
                return;
            }

            const now = new Date();
            const sortie = {
                id: now.getTime(),
                date: document.getElementById('date').value,
                heureSortie: now.toTimeString().slice(0,5),
                conducteur: document.getElementById('conducteur').value,
                niveauCarburant: document.getElementById('niveauCarburant').value,
                typeMission: document.getElementById('typeMission').value,
                clientNom: document.getElementById('clientNom').value,
                clientTel: tel,
                lieuDepart: document.getElementById('lieuDepart').value,
                lieuArrivee: document.getElementById('lieuArrivee').value,
                kmDepart: parseInt(document.getElementById('kmDepart').value),
                immatriculation: document.getElementById('immatriculation').value,
                marque: document.getElementById('marque').value,
                modele: document.getElementById('modele').value,
                commentaire: document.getElementById('commentaire').value,
                statut: 'en_cours',
                heureArrivee: null,
                kmIntervention: null,
                diagnostic: null,
                carteGrise: null,
                nonRoulant: null,
                photos: [],
                signature: null,
                heureDepart: null,
                heureRetour: null,
                kmFinal: null,
                peage: 'Non',
                montantPeage: 0
            };

            console.log('üì¶ Sortie cr√©√©e:', sortie);
            sorties.push(sortie);
            
            if (sauvegarderDonnees()) {
                console.log('‚úÖ Sortie enregistr√©e avec succ√®s');
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'none';
                }, 3000);
                
                this.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('lieuDepart').value = 'ECA VD, 6 Quartier les Rami√®res, 07800 Beauchastel';
                document.getElementById('niveauCarburant').value = 50;
                updateFuel(50);
                
                afficherEnCours();
                afficherSuivi();
            }
        });

        // AFFICHAGE SORTIES EN COURS
        function afficherEnCours() {
            const liste = document.getElementById('listeEnCours');
            const empty = document.getElementById('emptyEnCours');
            
            const enCours = sorties.filter(s => s.statut === 'en_cours');
            
            if (enCours.length === 0) {
                liste.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            let html = '';
            
            enCours.forEach((s, index) => {
                const realIndex = sorties.findIndex(x => x.id === s.id);
                html += `
                    <div class="intervention-card">
                        <div class="intervention-header">
                            <div>
                                <h3 style="margin:0">${s.immatriculation} - ${s.marque} ${s.modele}</h3>
                                <p style="margin-top:5px;font-weight:600">Client: ${s.clientNom}</p>
                                <p style="margin-top:5px"><a href="tel:${s.clientTel}" style="color:#2196F3;text-decoration:none;font-weight:600">üìû ${s.clientTel}</a></p>
                            </div>
                            <span class="status-badge status-en-cours">En cours</span>
                        </div>
                        <p><strong>D√©part:</strong> ${s.heureSortie}</p>
                        <p><strong>Destination:</strong> <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.lieuArrivee)}" target="_blank" style="color:#2196F3">üìç ${s.lieuArrivee}</a></p>
                        <div style="margin-top:15px">
                            ${!s.heureArrivee ? `<button class="btn-small btn-edit" onclick="arrivee(${realIndex})">üìç Arriv√©e sur place</button>` : ''}
                            ${s.heureArrivee && !s.signatureValidee ? `<button class="btn-small btn-edit" onclick="priseEnCharge(${realIndex})">‚úçÔ∏è Prise en charge</button>` : ''}
                            ${s.signatureValidee && !s.heureRetour ? `<button class="btn-small btn-complete" onclick="retour(${realIndex})">üèÅ Retour garage</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            liste.innerHTML = html;
        }

        // AFFICHAGE SUIVI
        function afficherSuivi() {
            const tbody = document.getElementById('tableSuivi');
            const empty = document.getElementById('emptySuivi');
            
            if (sorties.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            let html = '';
            
            sorties.forEach((s, idx) => {
                html += `
                    <tr>
                        <td>${new Date(s.date).toLocaleDateString('fr-FR')}</td>
                        <td>${s.heureSortie}</td>
                        <td>${s.conducteur}</td>
                        <td>${s.clientNom}<br><small>${s.clientTel}</small></td>
                        <td>${s.immatriculation}<br><small>${s.marque} ${s.modele}</small></td>
                        <td><span class="status-badge ${s.statut === 'en_cours' ? 'status-en-cours' : ''}">${s.statut === 'en_cours' ? 'En cours' : 'Termin√©e'}</span></td>
                        <td>
                            ${s.statut === 'terminee' && s.pdfGenere ? `<button class="btn-small btn-pdf" onclick="telechargerPDF(${idx})">üìÑ PDF</button>` : ''}
                            ${s.photosValidees ? `<span style="color:#4CAF50;font-size:0.9em;">‚úì ${s.nbPhotos} photos</span>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // MODAL
        function openModal(content) {
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // ARRIV√âE SUR PLACE
       function arrivee(index) {
  openModal(`
    <h3>Arriv√©e sur place</h3>
    <form id="formArrivee">
      <div class="form-group">
        <label class="required">Heure d'arriv√©e</label>
        <input type="time" id="heureArrivee" value="${nowHHMM()}" required>
      </div>
      <div class="form-group">
        <label class="required">KM intervention</label>
        <input type="number" id="kmIntervention" required>
      </div>
      <div class="form-group">
        <label>Diagnostic</label>
        <input type="text" id="diagnostic">
      </div>

      <div class="form-group">
        <label class="required">Carte grise pr√©sente</label>
        <div class="radio-group">
          <label><input type="radio" name="cg" value="Oui" required> Oui</label>
          <label><input type="radio" name="cg" value="Non" required> Non</label>
        </div>
      </div>

      <div class="form-group">
        <label class="required">V√©hicule non roulant</label>
        <div class="radio-group">
          <label><input type="radio" name="nr" value="Oui" required> Oui</label>
          <label><input type="radio" name="nr" value="Non" required> Non</label>
        </div>
      </div>

      <hr style="margin:18px 0">

      <h4 style="margin:0 0 10px 0;color:#000;">üì∏ Photos (hors appli)</h4>
      <div class="help-text" style="margin-bottom:10px;">
        Prenez les photos avec l‚Äôappareil photo du t√©l√©phone (elles restent dans la galerie).<br>
        Ensuite, cochez la conformit√© ici.
      </div>

      <div class="form-group">
        <label class="required">Checklist photos (5 obligatoires)</label>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
          <label><input type="checkbox" class="ph" value="AVD"> 3/4 avant droit</label>
          <label><input type="checkbox" class="ph" value="AVG"> 3/4 avant gauche</label>
          <label><input type="checkbox" class="ph" value="ARD"> 3/4 arri√®re droit</label>
          <label><input type="checkbox" class="ph" value="ARG"> 3/4 arri√®re gauche</label>
          <label><input type="checkbox" class="ph" value="COMPTEUR"> Compteur</label>
        </div>
        <div class="help-text" id="phCount">0/5 valid√©es</div>
      </div>

      <div class="form-group">
        <label>Photos suppl√©mentaires (optionnel)</label>
        <input type="number" id="photosSuppCount" min="0" value="0">
        <div class="help-text">Indiquer combien de photos en plus ont √©t√© prises.</div>
      </div>

      <button type="submit" class="submit-btn">Valider</button>
    </form>
  `);

  // compteur checklist
  const updateCount = () => {
    const checked = document.querySelectorAll('.ph:checked').length;
    document.getElementById('phCount').textContent = `${checked}/5 valid√©es`;
  };
  document.querySelectorAll('.ph').forEach(cb => cb.addEventListener('change', updateCount));
  updateCount();

  document.getElementById('formArrivee').addEventListener('submit', (e) => {
    e.preventDefault();

    const checked = document.querySelectorAll('.ph:checked').length;
    if (checked !== 5) {
      alert('Les 5 photos obligatoires doivent √™tre coch√©es (conformes).');
      return;
    }

    sorties[index].heureArrivee = document.getElementById('heureArrivee').value;
    sorties[index].kmIntervention = safeParseInt(document.getElementById('kmIntervention').value);
    sorties[index].diagnostic = document.getElementById('diagnostic').value || null;
    sorties[index].carteGrise = document.querySelector('input[name="cg"]:checked').value;
    sorties[index].nonRoulant = document.querySelector('input[name="nr"]:checked').value;

    const supp = parseInt(document.getElementById('photosSuppCount').value || '0', 10);
    sorties[index].nbPhotos = 5 + (Number.isFinite(supp) ? supp : 0);
    sorties[index].photosValidees = true;

    if (sauvegarderDonnees()) {
      closeModal();
      afficherEnCours();
      alert(`‚úÖ Arriv√©e enregistr√©e\nüì∏ ${sorties[index].nbPhotos} photo(s) d√©clar√©e(s)`);
    }
  });
}

            }
        }

        // PRISE EN CHARGE
        function priseEnCharge(index) {
            openModal(`
                <h3>Prise en charge client</h3>
                <p><strong>Client:</strong> ${sorties[index].clientNom}</p>
                <p><strong>V√©hicule:</strong> ${sorties[index].immatriculation} - ${sorties[index].marque} ${sorties[index].modele}</p>
                <form onsubmit="validerPriseEnCharge(${index}); return false;">
                    <div class="form-group">
                        <label class="required">Heure de d√©part du lieu</label>
                        <input type="time" id="heureDepart" value="${new Date().toTimeString().slice(0,5)}" required>
                    </div>
                    <div class="form-group">
                        <label class="required">Nom du signataire (client)</label>
                        <input type="text" id="nomSignataire" placeholder="Nom et pr√©nom du client" required>
                        <div class="help-text">Le client confirme la prise en charge du v√©hicule</div>
                    </div>
                    <button type="submit" class="submit-btn">‚úÖ Valider</button>
                </form>
            `);
        }

        function validerPriseEnCharge(index) {
            const nomSignataire = document.getElementById('nomSignataire').value.trim();
            if (!nomSignataire) {
                alert('‚ö†Ô∏è Le nom du signataire est obligatoire');
                return;
            }
            
            sorties[index].heureDepart = document.getElementById('heureDepart').value;
            sorties[index].signataireNom = nomSignataire;
            sorties[index].signatureValidee = true;
            
            if (sauvegarderDonnees()) {
                closeModal();
                afficherEnCours();
                alert('‚úÖ Prise en charge enregistr√©e\n‚úçÔ∏è Signataire: ' + nomSignataire);
            }
        }

        // RETOUR GARAGE
        function retour(index) {
            openModal(`
                <h3>Retour au garage</h3>
                <form onsubmit="validerRetour(${index}); return false;">
                    <div class="form-group">
                        <label class="required">Heure retour garage</label>
                        <input type="time" id="heureRetour" value="${new Date().toTimeString().slice(0,5)}" required>
                    </div>
                    <div class="form-group">
                        <label class="required">KM arriv√©e garage</label>
                        <input type="number" id="kmFinal" required>
                    </div>
                    <div class="form-group">
                        <label>Y a-t-il eu un p√©age ?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="peage" value="Oui" onchange="document.getElementById('montantPeage').style.display='block'"> Oui</label>
                            <label><input type="radio" name="peage" value="Non" checked onchange="document.getElementById('montantPeage').style.display='none'"> Non</label>
                        </div>
                    </div>
                    <div class="form-group" id="montantPeage" style="display:none">
                        <label>Montant p√©age (‚Ç¨)</label>
                        <input type="number" step="0.01" id="peageMontant">
                    </div>
                    <button type="submit" class="submit-btn">Cl√¥turer</button>
                </form>
            `);
        }

        function validerRetour(index) {
            sorties[index].heureRetour = document.getElementById('heureRetour').value;
            sorties[index].kmFinal = parseInt(document.getElementById('kmFinal').value);
            sorties[index].peage = document.querySelector('input[name="peage"]:checked').value;
            sorties[index].montantPeage = sorties[index].peage === 'Oui' ? (parseFloat(document.getElementById('peageMontant').value) || 0) : 0;
            sorties[index].statut = 'terminee';
            
            // G√©n√©rer le PDF
            console.log('üìÑ G√©n√©ration du PDF...');
            genererPDF(index);
            
            if (sauvegarderDonnees()) {
                closeModal();
                afficherEnCours();
                afficherSuivi();
                alert('‚úÖ Intervention cl√¥tur√©e avec succ√®s !\nüìÑ PDF g√©n√©r√© et disponible dans Suivi');
            }
        }

        function genererPDF(index) {
            const s = sorties[index];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-t√™te
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('EYRIEUX CENTRE AUTO', 20, 20);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('6 Quartier les Rami√®res', 20, 26);
            doc.text('07800 BEAUCHASTEL', 20, 31);
            doc.text('T√©l : 04 75 62 25 61', 20, 36);
            
            // Titre
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('R√©sum√© de l\'intervention', 105, 50, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`N¬∞ de dossier : ${s.id}`, 105, 57, { align: 'center' });
            
            let y = 70;
            
            // V√âHICULE
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('V√©hicule', 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Immatriculation : ${s.immatriculation}`, 20, y);
            doc.text(`Carte Grise : ${s.carteGrise}`, 105, y);
            y += 6;
            doc.text(`Mod√®le : ${s.modele} (${s.marque})`, 20, y);
            doc.text(`Non-roulant : ${s.nonRoulant}`, 105, y);
            y += 6;
            doc.text(`Panne : ${s.diagnostic || 'N/A'}`, 20, y);
            y += 15;
            
            // B√âN√âFICIAIRE
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('B√©n√©ficiaire', 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Nom : ${s.clientNom}`, 20, y);
            doc.text(`Appel : ${new Date(s.date).toLocaleDateString('fr-FR')}`, 105, y);
            y += 6;
            doc.text(`Tel : ${s.clientTel}`, 20, y);
            y += 15;
            
            // MISSION
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Mission', 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Type : ${s.typeMission}`, 20, y);
            y += 6;
            doc.text(`D√©panneur : ${s.conducteur}`, 20, y);
            y += 6;
            doc.text(`Diagnostique : ${s.diagnostic || 'N/A'}`, 20, y);
            y += 8;
            doc.text(`Acceptation : ${s.heureSortie}`, 20, y);
            doc.text(`Arriv√©e sur place : ${s.heureArrivee || 'N/A'}`, 105, y);
            y += 6;
            doc.text(`D√©part sur place : ${s.heureDepart || 'N/A'}`, 20, y);
            y += 10;
            doc.setFontSize(9);
            doc.text(`Adresse de prise en charge :`, 20, y);
            y += 5;
            doc.text(s.lieuArrivee, 20, y);
            y += 6;
            doc.text(`Adresse de d√©pose :`, 20, y);
            y += 5;
            doc.text(s.lieuDepart, 20, y);
            y += 15;
            
            // SIGNATURE
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Signature du client', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            if (s.signataireNom) {
                doc.text(`Signataire : ${s.signataireNom}`, 20, y);
                y += 6;
            }
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'italic');
            doc.text('Le propri√©taire du v√©hicule d√©clare avoir lu et accept√© les CGV', 20, y);
            
            const pdfData = doc.output('datauristring');
            sorties[index].pdfGenere = pdfData;
            console.log('‚úÖ PDF g√©n√©r√©');
        }

        function telechargerPDF(index) {
            const s = sorties[index];
            if (!s.pdfGenere) {
                alert('PDF non disponible');
                return;
            }
            const link = document.createElement('a');
            link.href = s.pdfGenere;
            link.download = `Intervention_${s.id}_${s.date}.pdf`;
            link.click();
            console.log('üì• PDF t√©l√©charg√©');
        }

        // Fermer modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            if (event.target == document.getElementById('modal')) {
                closeModal();
            }
        }

        console.log('‚úÖ Application pr√™te');
    </script>
</body>
</html>
